<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kasir - Cetak Struk</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
    }
    select, input, button {
      margin: 8px 0;
      padding: 10px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      cursor: pointer;
      transition: 0.3s;
      border: none;
    }
    button:hover { opacity: 0.9; }
    .btn-primary { background: #007bff; color: white; }
    .btn-success { background: #28a745; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .btn-warning { background: #ffc107; color: black; }
    .struk {
      margin-top: 20px;
      padding: 20px;
      background: #fff;
      border: 1px dashed #000;
      border-radius: 6px;
      font-size: 14px;
      line-height: 1.6;
    }
    .actions button {
      margin: 5px 0;
      width: 48%;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üõí Kasir - Cetak Struk</h2>

    <h3>Pilih Menu</h3>
    <select id="pilihMenu"></select>
    <input type="number" id="jumlah" placeholder="Jumlah" min="1" value="1">
    <button class="btn-success" onclick="tambahPesanan()">Tambah Pesanan</button>

    <div class="struk" id="strukArea">
      <h3 style="text-align:center;">üßæ STRUK PEMBAYARAN</h3>
      <div id="isiStruk"></div>
      <hr>
      <p id="subtotal"></p>
      <p id="diskonInfo"></p>
      <h4 id="total"></h4>
    </div>

    <div class="actions">
      <button class="btn-primary" onclick="cetakStruk()">üñ®Ô∏è Cetak</button>
      <button class="btn-warning" onclick="downloadPNG()">üì∑ PNG</button>
      <button class="btn-danger" onclick="downloadPDF()">üìÑ PDF</button>
      <button class="btn-success" onclick="bagikanStruk()">üì§ Bagikan</button>
    </div>
  </div>

  <script>
    let pesanan = [];
    let menuData = JSON.parse(localStorage.getItem('menuData')) || [];
    let diskon = JSON.parse(localStorage.getItem('diskonData')) || { tipe: "persen", nilai: 0 };

    // format rupiah dengan titik
    function formatRupiah(angka) {
      return "Rp " + angka.toLocaleString("id-ID");
    }

    // tampilkan menu di select
    function tampilkanMenu() {
      const select = document.getElementById("pilihMenu");
      select.innerHTML = "";
      menuData.forEach((item, i) => {
        let option = document.createElement("option");
        option.value = i;
        option.textContent = `${item.kategori} - ${item.nama} (${formatRupiah(item.harga)})`;
        select.appendChild(option);
      });
    }

    function tambahPesanan() {
      const idx = document.getElementById("pilihMenu").value;
      const jumlah = parseInt(document.getElementById("jumlah").value);

      if (idx === "" || jumlah < 1) {
        alert("Pilih menu dan masukkan jumlah!");
        return;
      }

      const item = menuData[idx];
      pesanan.push({ ...item, jumlah });
      tampilkanStruk();
    }

    function tampilkanStruk() {
      let isi = document.getElementById("isiStruk");
      isi.innerHTML = "";
      let subtotal = 0;

      let kategoriCount = { Makanan: 0, Minuman: 0, Lainnya: 0 };

      pesanan.forEach(p => {
        let totalItem = p.harga * p.jumlah;
        subtotal += totalItem;
        kategoriCount[p.kategori] += p.jumlah;
        isi.innerHTML += `<p>${p.nama} (${p.kategori}) x${p.jumlah} - ${formatRupiah(totalItem)}</p>`;
      });

      // tampilkan ringkasan jumlah per kategori
      isi.innerHTML += `<hr>
        <p><b>Ringkasan:</b></p>
        <p>Makanan: ${kategoriCount.Makanan}</p>
        <p>Minuman: ${kategoriCount.Minuman}</p>
        <p>Lainnya: ${kategoriCount.Lainnya}</p>`;

      document.getElementById("subtotal").innerText = "Subtotal: " + formatRupiah(subtotal);

      // hitung diskon
      let potongan = 0;
      if (diskon.nilai > 0) {
        if (diskon.tipe === "persen") {
          potongan = (subtotal * diskon.nilai) / 100;
          document.getElementById("diskonInfo").innerText = `Diskon ${diskon.nilai}% : -${formatRupiah(potongan)}`;
        } else {
          potongan = diskon.nilai;
          document.getElementById("diskonInfo").innerText = `Diskon Potongan: -${formatRupiah(potongan)}`;
        }
      } else {
        document.getElementById("diskonInfo").innerText = "";
      }

      let total = subtotal - potongan;
      if (total < 0) total = 0;
      document.getElementById("total").innerText = "Total: " + formatRupiah(total);
    }

    function cetakStruk() {
      window.print();
    }

    function downloadPNG() {
      html2canvas(document.getElementById("strukArea")).then(canvas => {
        const link = document.createElement("a");
        link.download = "struk.png";
        link.href = canvas.toDataURL();
        link.click();
      });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const canvas = await html2canvas(document.getElementById("strukArea"));
      const imgData = canvas.toDataURL("image/png");
      const imgProps = doc.getImageProperties(imgData);
      const pdfWidth = doc.internal.pageSize.getWidth();
      const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
      doc.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
      doc.save("struk.pdf");
    }

    async function bagikanStruk() {
      const canvas = await html2canvas(document.getElementById("strukArea"));
      canvas.toBlob(async (blob) => {
        const file = new File([blob], "struk.png", { type: "image/png" });
        if (navigator.share) {
          await navigator.share({
            title: "Struk Pembayaran",
            text: "Berikut struk pembayaran Anda",
            files: [file]
          });
        } else {
          alert("Fitur share tidak tersedia di perangkat ini");
        }
      });
    }

    tampilkanMenu();
  </script>
</body>
</html>
