<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Struk Pembayaran</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      max-width: 400px;
      width: 100%;
    }
    h2 {
      text-align: center;
      margin-bottom: 15px;
    }
    form label {
      margin-top: 10px;
      display: block;
      font-weight: bold;
    }
    select, input {
      margin-top: 5px;
      padding: 10px;
      width: 100%;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
      transition: 0.3s;
    }
    input:focus, select:focus {
      border-color: #6c63ff;
      box-shadow: 0 0 5px #6c63ff;
    }
    button {
      background: linear-gradient(135deg, #6c63ff, #48c6ef);
      border: none;
      padding: 10px 15px;
      color: white;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 15px;
      width: 100%;
      font-size: 15px;
      transition: 0.3s;
    }
    button:hover {
      transform: scale(1.05);
      box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }
    #strukOutput {
      background: #fafafa;
      border: 1px dashed #000;
      padding: 20px;
      margin: 20px auto;
      font-family: monospace;
      line-height: 1.4em;
      border-radius: 10px;
    }
    #strukOutput h3 { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; }
    .btn-group {
      margin-top: 15px;
      display: grid;
      gap: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Struk Pembayaran</h2>
    <form id="paymentForm">
      <label for="menu">Pilih Menu</label>
      <select id="menu"></select>

      <label for="jumlah">Jumlah</label>
      <input type="number" id="jumlah" min="1" value="1">

      <button type="button" onclick="tambahPesanan()">‚ûï Tambah ke Daftar</button>
      <button type="submit">üßæ Buat Struk</button>
    </form>

    <div id="daftarPesanan" style="margin-top:15px;"></div>

    <div id="strukOutput" style="display:none;"></div>

    <div class="btn-group" id="aksiStruk" style="display:none;">
      <button onclick="printStruk()">üñ®Ô∏è Print</button>
      <button onclick="downloadPNG()">üì∑ Download PNG</button>
      <button onclick="downloadPDF()">üìÑ Download PDF</button>
      <button onclick="shareStruk()">üì§ Bagikan</button>
    </div>
  </div>

  <script>
    let pesanan = [];

    function formatRupiah(angka) {
      return angka.toLocaleString("id-ID");
    }

    function loadMenuOptions() {
      const menu = JSON.parse(localStorage.getItem('menuData')) || [];
      const menuSelect = document.getElementById('menu');
      menuSelect.innerHTML = '';
      menu.forEach((item, index) => {
        menuSelect.innerHTML += `<option value="${index}">${item.kategori} - ${item.nama} : Rp${formatRupiah(item.harga)}</option>`;
      });
    }

    function tambahPesanan() {
      const menu = JSON.parse(localStorage.getItem('menuData')) || [];
      const selectedIndex = document.getElementById('menu').value;
      const jumlah = parseInt(document.getElementById('jumlah').value);
      const selectedItem = menu[selectedIndex];
      if (!selectedItem) return alert("Menu tidak tersedia");

      pesanan.push({ ...selectedItem, jumlah });
      tampilkanPesanan();
    }

    function tampilkanPesanan() {
      const daftarPesanan = document.getElementById('daftarPesanan');
      daftarPesanan.innerHTML = "<h4>üõí Daftar Pesanan:</h4>";
      pesanan.forEach((item, idx) => {
        daftarPesanan.innerHTML += `
          <p>${item.kategori} - ${item.nama} x${item.jumlah} @Rp${formatRupiah(item.harga)} 
          = Rp${formatRupiah(item.harga * item.jumlah)} 
          <button onclick="hapusPesanan(${idx})" style="margin-left:10px;background:#ff4b5c;color:white;border:none;padding:2px 6px;border-radius:5px;">Hapus</button></p>`;
      });
    }

    function hapusPesanan(index) {
      pesanan.splice(index, 1);
      tampilkanPesanan();
    }

    document.getElementById('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      if (pesanan.length === 0) {
        alert("Tambahkan pesanan dulu!");
        return;
      }

      let total = 0;
      let totalItem = 0;
      let detailPesanan = "";
      let kategoriCount = {};

      pesanan.forEach(item => {
        const subtotal = item.harga * item.jumlah;
        total += subtotal;
        totalItem += item.jumlah;

        if (!kategoriCount[item.kategori]) kategoriCount[item.kategori] = 0;
        kategoriCount[item.kategori] += item.jumlah;

        detailPesanan += `${item.nama} x${item.jumlah} = Rp${formatRupiah(subtotal)}\n`;
      });

      let ringkasanKategori = "";
      for (const kategori in kategoriCount) {
        ringkasanKategori += `${kategori} : ${kategoriCount[kategori]} item\n`;
      }

      // ambil diskon dari localStorage
      const diskonData = JSON.parse(localStorage.getItem('diskonData')) || { persen: 0, potongan: 0 };

      // hitung diskon
      let diskonPersen = (total * diskonData.persen) / 100;
      let totalSetelahDiskon = total - diskonPersen - diskonData.potongan;
      if (totalSetelahDiskon < 0) totalSetelahDiskon = 0;

      const tanggal = new Date().toLocaleString("id-ID");

      document.getElementById('strukOutput').style.display = "block";
      document.getElementById('aksiStruk').style.display = "grid";
      document.getElementById('strukOutput').innerHTML = `
        <h3>WARUNG MAKAN</h3>
        <p>Tanggal: ${tanggal}</p>
        <p>------------------------------</p>
        <pre>${detailPesanan}</pre>
        <p>------------------------------</p>
        <pre>${ringkasanKategori}</pre>
        <p><b>Total Sebelum Diskon: Rp${formatRupiah(total)}</b></p>
        ${diskonData.persen > 0 ? `<p>Diskon ${diskonData.persen}% : - Rp${formatRupiah(diskonPersen)}</p>` : ""}
        ${diskonData.potongan > 0 ? `<p>Potongan Harga: - Rp${formatRupiah(diskonData.potongan)}</p>` : ""}
        <h4>Total Akhir: Rp${formatRupiah(totalSetelahDiskon)}</h4>
        <p><b>Jumlah Item : ${totalItem}</b></p>
        <p>------------------------------</p>
        <p>Terima Kasih üôè</p>
      `;
    });

    function printStruk() {
      const printContent = document.getElementById('strukOutput').innerHTML;
      const w = window.open('', '', 'width=400,height=600');
      w.document.write('<pre>' + printContent + '</pre>');
      w.document.close();
      w.print();
    }

    function downloadPNG() {
      const struk = document.getElementById('strukOutput');
      html2canvas(struk).then(canvas => {
        const link = document.createElement("a");
        link.download = "struk.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const struk = document.getElementById('strukOutput');
      await html2canvas(struk).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const imgProps= pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("struk.pdf");
      });
    }

    async function shareStruk() {
      const struk = document.getElementById('strukOutput');
      const canvas = await html2canvas(struk);
      canvas.toBlob(blob => {
        const file = new File([blob], "struk.png", { type: "image/png" });
        if (navigator.share) {
          navigator.share({
            title: "Struk Pembayaran",
            text: "Berikut struk pembelian Anda",
            files: [file]
          }).catch(err => console.log("Gagal berbagi:", err));
        } else {
          alert("Fitur berbagi tidak didukung di perangkat ini");
        }
      });
    }

    window.onload = loadMenuOptions;
  </script>
</body>
</html>
