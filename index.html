<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Struk Pembayaran</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .container { max-width: 400px; margin: auto; }
    form { margin-bottom: 20px; }

    /* Style struk seperti kertas */
    #strukOutput {
      background: white;
      border: 1px dashed #000;
      padding: 20px;
      width: 300px;
      margin: 20px auto;
      font-family: monospace;
      line-height: 1.4em;
    }
    #strukOutput h3 { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 5px; }
    #strukOutput p { margin: 3px 0; }
    .btn-group { margin-top: 15px; text-align: center; }
    button { margin: 5px; padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Struk Pembayaran</h2>
    <form id="paymentForm">
      <label for="menu">Pilih Menu</label>
      <select id="menu"></select>

      <label for="jumlah">Jumlah</label>
      <input type="number" id="jumlah" min="1" value="1">

      <button type="submit">Buat Struk</button>
    </form>

    <div id="strukOutput" style="display:none;"></div>

    <div class="btn-group" id="aksiStruk" style="display:none;">
      <button onclick="printStruk()">üñ®Ô∏è Print</button>
      <button onclick="downloadPNG()">üì∑ PNG</button>
      <button onclick="downloadPDF()">üìÑ PDF</button>
      <button onclick="shareStruk()">üì§ Bagikan</button>
    </div>
  </div>

  <script>
    function loadMenuOptions() {
      const menu = JSON.parse(localStorage.getItem('menuData')) || [];
      const menuSelect = document.getElementById('menu');
      menuSelect.innerHTML = '';
      menu.forEach((item, index) => {
        menuSelect.innerHTML += `<option value="${index}">${item.kategori} - ${item.nama} : Rp${item.harga}</option>`;
      });
    }

    document.getElementById('paymentForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const menu = JSON.parse(localStorage.getItem('menuData')) || [];
      const selectedIndex = document.getElementById('menu').value;
      const jumlah = parseInt(document.getElementById('jumlah').value);
      const selectedItem = menu[selectedIndex];

      if (!selectedItem) {
        alert("Menu tidak tersedia");
        return;
      }

      const total = selectedItem.harga * jumlah;
      const tanggal = new Date().toLocaleString("id-ID");

      document.getElementById('strukOutput').style.display = "block";
      document.getElementById('aksiStruk').style.display = "block";
      document.getElementById('strukOutput').innerHTML = `
        <h3>WARUNG MAKAN</h3>
        <p>Tanggal: ${tanggal}</p>
        <p>------------------------------</p>
        <p>Menu : ${selectedItem.nama}</p>
        <p>Harga : Rp${selectedItem.harga}</p>
        <p>Jumlah: ${jumlah}</p>
        <p>------------------------------</p>
        <p><b>Total : Rp${total}</b></p>
        <p>------------------------------</p>
        <p>Terima Kasih üôè</p>
      `;
    });

    function printStruk() {
      const printContent = document.getElementById('strukOutput').innerHTML;
      const w = window.open('', '', 'width=400,height=600');
      w.document.write('<pre>' + printContent + '</pre>');
      w.document.close();
      w.print();
    }

    function downloadPNG() {
      const struk = document.getElementById('strukOutput');
      html2canvas(struk).then(canvas => {
        const link = document.createElement("a");
        link.download = "struk.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
      });
    }

    async function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      const struk = document.getElementById('strukOutput');
      await html2canvas(struk).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const imgProps= pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("struk.pdf");
      });
    }

    async function shareStruk() {
      const struk = document.getElementById('strukOutput');
      const canvas = await html2canvas(struk);
      canvas.toBlob(blob => {
        const file = new File([blob], "struk.png", { type: "image/png" });
        if (navigator.share) {
          navigator.share({
            title: "Struk Pembayaran",
            text: "Berikut struk pembelian Anda",
            files: [file]
          }).catch(err => console.log("Gagal berbagi:", err));
        } else {
          alert("Fitur berbagi tidak didukung di perangkat ini");
        }
      });
    }

    window.onload = loadMenuOptions;
  </script>
</body>
</html>
